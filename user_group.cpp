#include <iostream>
#include <fstream>
#include <sstream>
#include <vector>
#include <string>
#include <map>
using namespace std;

extern class OTP;
extern class Wallet;

class User {
public:
    string username, password, fullName, email, phone;
    Role role;
    Wallet wallet;
    bool mustChangePassword = false;

    User(string u = "", string p = "", string name = "", string em = "", string ph = "", Role r = Role::User)
        : username(u), password(p), fullName(name), email(em), phone(ph), role(r), wallet("WALLET_" + u, 0) {}

    void displayUserInfo() {
        cout << "\n--- ThÃ´ng tin ngÆ°á»i dÃ¹ng ---\n";
        cout << "TÃªn Ä‘Äƒng nháº­p: " << username << "\nHá» tÃªn: " << fullName << "\nEmail: " << email << "\nSÄT: " << phone;
        cout << "\nVai trÃ²: " << (role == Role::Manager ? "Quáº£n lÃ½" : "NgÆ°á»i dÃ¹ng") << "\n";
    }

    void backupToFile() {
        time_t now = time(0);
        ofstream file("backup_users.txt", ios::app);
        if (file.is_open()) {
            file << username << "|" << password << "|" << fullName << "|" << email << "|" << phone << "|";
            file << (role == Role::Manager ? "Manager" : "User") << "|" << wallet.getBalance() << "|" << ctime(&now);
            file.close();
        }
    }

    void restoreFromBackupLine(const string& line) {
        stringstream ss(line);
        string token;
        getline(ss, username, '|');
        getline(ss, password, '|');
        getline(ss, fullName, '|');
        getline(ss, email, '|');
        getline(ss, phone, '|');
        getline(ss, token, '|');
        role = (token == "Manager") ? Role::Manager : Role::User;
        getline(ss, token, '|');
        wallet = Wallet("WALLET_" + username);
        wallet.setBalance(stoi(token));
        mustChangePassword = false;
    }

    void updateUserInfo(OTP& otp, bool isAdmin = false);
    
};

// Tranh trung lap tÃªn dnhap
void registerUserAccount() {
    string u, p, n, e, ph;
    cout << "\n=== ÄÄƒng kÃ½ tÃ i khoáº£n ===\n";
    
    // Kiá»ƒm tra trÃ¹ng username
    while (true) {
        cout << "TÃªn Ä‘Äƒng nháº­p: ";
        cin >> u;
        if (users.count(u)) {
            cout << "âŒ TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i. Vui lÃ²ng chá»n tÃªn khÃ¡c.\n";
        } else {
            break;
        }
    }

    cout << "Máº­t kháº©u (Ä‘á»ƒ trá»‘ng Ä‘á»ƒ há»‡ thá»‘ng táº¡o): ";
    cin.ignore();
    getline(cin, p);
    bool autoGenerated = false;

    if (p.empty()) {
        string autoPass = "";
        string chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        for (int i = 0; i < 8; ++i)
            autoPass += chars[rand() % chars.size()];
        p = autoPass;
        autoGenerated = true;
        cout << "ðŸ” Máº­t kháº©u tá»± sinh: " << p << "\n";
    }

    cout << "Há» tÃªn: "; getline(cin, n);
    cout << "Email: "; getline(cin, e);
    cout << "SÄT: "; getline(cin, ph);

    users[u] = User(u, p, n, e, ph);
    users[u].wallet.deposit(1000);
    users[u].mustChangePassword = autoGenerated;

    Transaction tx = {"MASTER", users[u].wallet.getID(), 1000, "Cáº¥p Ä‘iá»ƒm ban Ä‘áº§u"};
    users[u].wallet.addTransaction(tx);
    masterWallet.addTransaction(tx);
    saveTransactionToFile(tx);
    groups[0].addMember(&users[u]);
    users[u].backupToFile();

    cout << "âœ… ÄÃ£ táº¡o tÃ i khoáº£n thÃ nh cÃ´ng vá»›i vai trÃ²: NgÆ°á»i dÃ¹ng.\n";
}

class Group {
    string groupName;
    vector<User*> members;
public:
    Group(string name) : groupName(name) {}
    void addMember(User* u) { members.push_back(u); }
    void showGroupInfo() {
        cout << "\n--- NhÃ³m: " << groupName << " ---\n";
        for (auto m : members) m->displayUserInfo();
    }
};

void userMenu(string u) {
        int ch;
        while (true) {
            cout << "\n--- Menu ngÆ°á»i dÃ¹ng ---\n";
            cout << "1. Xem vÃ­\n2. Chuyá»ƒn Ä‘iá»ƒm\n3. Cáº­p nháº­t thÃ´ng tin\n4. Sao lÆ°u tÃ i khoáº£n\n5. ThoÃ¡t\nChá»n: ";
            cin >> ch;
            if (ch == 5) break;
            if (ch == 1) {
                users[u].wallet.showBalance();
                users[u].wallet.showHistory();
            } else if (ch == 2) {
                string to; int amt;
                cout << "Chuyá»ƒn Ä‘áº¿n (username): "; cin >> to;
                if (!users.count(to)) { cout << "âŒ KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i nháº­n.\n"; continue; }
                cout << "Sá»‘ Ä‘iá»ƒm: "; cin >> amt;
                if (amt <= 0) {
                    cout << "âŒ Sá»‘ Ä‘iá»ƒm pháº£i lá»›n hÆ¡n 0.\n";
                    continue;
                }
                string code = otp.generateOTP();
                cout << "Nháº­p mÃ£ OTP: "; string in; cin >> in;
                if (!otp.validateOTP(in)) { cout << "âŒ Sai OTP.\n"; continue; }
                if (users[u].wallet.withdraw(amt)) {
                    users[to].wallet.deposit(amt);
                    Transaction tx = {users[u].wallet.getID(), users[to].wallet.getID(), amt, "ThÃ nh cÃ´ng"};
                    users[u].wallet.addTransaction(tx);
                    users[to].wallet.addTransaction(tx);
                    saveTransactionToFile(tx);
                    cout << "âœ… Giao dá»‹ch thÃ nh cÃ´ng.\n";
                } else cout << "âŒ KhÃ´ng Ä‘á»§ sá»‘ dÆ°.\n";
            } else if (ch == 3) {
                users[u].updateUserInfo(otp);
            } else if (ch == 4) {
                users[u].backupToFile();
                cout << "âœ… ÄÃ£ sao lÆ°u tÃ i khoáº£n.\n";
            }
        }
    }
